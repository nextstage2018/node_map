# NodeMap 引き継ぎ書

**作成日**: 2026年3月2日
**対象期間**: 秘書ファースト Phase A〜C + Phase B拡張 + Calendar連携 + ブリーフィング強化

---

## 今回のセッションで完了した作業

### 1. 秘書ファースト UI（Phase A〜C）
NodeMapのメイン画面を秘書AIチャット中心に再設計。

- **Phase A**: SecretaryChat.tsx（チャットUI）+ ChatCards.tsx（カードシステム）+ /api/agent/chat（意図分類＋カード生成API）
- **Phase B**: インラインカード統合（InboxSummary/TaskResume/JobApproval/Navigate/ActionResult）＋実データ連携
- **Phase C**: 返信下書きカード（ReplyDraftCard）＋承認→送信実行＋コンタクト情報連携

### 2. Phase B拡張（ジョブ自律実行）
秘書AIがジョブを自動実行する仕組みを追加。

- 「○○さんに返信しておいて」→ AI下書き生成 → 承認カード → 自動送信
- ジョブのライフサイクル: pending → approved → executing → done/failed
- Email/Slack/Chatwork への自動送信エンジン
- インラインドラフト編集対応

### 3. Google Calendar 連携
Gmail OAuthにカレンダースコープを追加し、秘書AIがカレンダーを参照・操作可能に。

- `calendarClient.service.ts`: 予定取得/作成/空き時間検索
- `/api/calendar`: GET（today/week/range/free）/ POST（予定作成）
- 秘書AIのブリーフィング・calendar・schedule意図で自動参照
- 日程調整ジョブ実行時にカレンダー予定自動作成

### 4. ブリーフィング強化
朝のブリーフィングにカレンダー・期限アラートを統合。

- **ブリーフィングサマリーカード**: 未読数/タスク数/ジョブ数/予定数/次の予定を一覧表示
- **カレンダー予定カード**: 今日の予定を時系列表示（進行中ハイライト）
- **期限アラートカード**: 期限切れ/今日/3日以内の期限をアラート表示
- AIプロンプトを改善（カード内容を繰り返さず、時間を意識したアドバイス生成）

---

## コミット履歴

| コミット | 内容 |
|---|---|
| （秘書Phase A〜C） | mainにマージ済み（前セッション） |
| `b69dead` | Phase B拡張+Calendar+ブリーフィング強化 |

---

## Supabaseで実行が必要なSQL

```sql
-- 031_phase_b_job_autonomous.sql（ジョブ自律実行カラム追加）
ALTER TABLE jobs ALTER COLUMN type SET DEFAULT 'other';
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS approved_at TIMESTAMPTZ;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS executed_at TIMESTAMPTZ;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS execution_log TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS reply_to_message_id TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS target_contact_id TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS target_address TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS target_name TEXT;
ALTER TABLE jobs ADD COLUMN IF NOT EXISTS execution_metadata JSONB;
CREATE INDEX IF NOT EXISTS idx_jobs_type ON jobs(type);
CREATE INDEX IF NOT EXISTS idx_jobs_reply_to ON jobs(reply_to_message_id);
```

---

## GCP設定（完了済み）

- Google Calendar API: 有効化済み
- OAuth同意画面: `calendar.readonly` + `calendar.events` スコープ追加済み

---

## 現在の主要画面の状態

| 画面 | 状態 | 備考 |
|---|---|---|
| 秘書（/agent） | ✅ メインUI | チャット＋インラインカード＋ブリーフィング |
| インボックス | ✅ 正常動作 | 返信/ジョブ/タスクの3ボタン |
| タスク | ✅ 正常動作 | タスク専用 |
| ジョブ | ✅ 正常動作 | 独立ページ＋秘書から自動実行可能 |
| アイデアメモ | ✅ 実装済み | AI会話付きメモ機能 |
| 思考マップ | ✅ 実装済み | 全体マップ/トレース/比較/リプレイ |
| カレンダー | ✅ 新規 | /api/calendar + 秘書AI統合 |
| コンタクト/組織 | ✅ 正常動作 | |
| ビジネスログ | ✅ 正常動作 | |

---

## 次に取り組むべき候補

### 優先度高
1. **Supabaseマイグレーション実行**: 031_phase_b_job_autonomous.sql（ジョブ自律実行に必要）
2. **Gmail再認証テスト**: カレンダースコープ追加後の動作確認
3. **秘書AIの実環境テスト**: ブリーフィング/カレンダー/ジョブ実行の一連フロー確認

### 優先度中
4. **秘書チャットのUX改善**: 会話履歴の永続化、チャット開始時の自動ブリーフィング
5. **ジョブ完了通知**: 秘書チャット外でのジョブ完了時にプッシュ通知的なUI
6. **カレンダーイベントカードにアクション追加**: 「この予定の前に○○の返信を」のようなフロー

### その他
7. auto生成コンタクト同士の連絡先結合
8. ビジネスログの活動履歴連携
9. Gmail再認証のUI導線（既存ユーザー向け再認証促進）

---

## 技術的な注意点（次の作業者向け）

- **Cowork VMにはディスク容量の制限あり**: `npm run build` は必ずローカルのターミナルで実行
- **zshでの[id]パス**: `git add "src/app/api/jobs/[id]/execute/route.ts"` のようにブラケットを引用符で囲む
- **Vercel互換**: Next.js 14の動的ルートは `{ params }: { params: Promise<{ id: string }> }` パターン
- **カレンダートークン再利用**: Gmail OAuthトークンをそのまま使用（user_service_tokens テーブル、service_name='gmail'）
- **AIモデル**: 全AI機能で `claude-sonnet-4-5-20250929` を使用（コスト最適化）
- **RLSバイパス**: サーバーサイドでは `getServerSupabase() || getSupabase()` パターン
