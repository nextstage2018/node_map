# NodeMap（仮）SSOT - Single Source of Truth

> **このファイルは各フェーズ間の引き継ぎ資料です。**
> 新しい会話を始めるとき、設計書（.docx）とこのファイルをエージェントに渡してください。
> 各フェーズ完了時にエージェントがこのファイルを更新します。

---

## 基本情報

| 項目 | 内容 |
|------|------|
| サービス名 | NodeMap（仮） |
| オーナー | sjinji |
| 開発方法 | v0.dev（デザイン）+ Claude Cowork（実装）|
| リポジトリ | https://github.com/nextstage2018/node_map |
| デプロイ先 | https://node-map-eight.vercel.app |
| ホスティング | Vercel |
| 設計書 | NodeMap_設計書_v2.docx |
| 定型文 | PROMPT_TEMPLATE.md |
| 再定義資料 | NODEMAP_再定義v2_議論まとめ.md |

---

## 現在のステータス

| フェーズ | ステータス | 完了日 | 備考 |
|----------|-----------|--------|------|
| 設計書作成 | ✅ 完了 | 2026-02-18 | v1.0（セクション7追加済み） |
| Phase 1：統合インボックス | ✅ 完了 | 2026-02-18 | デモモード動作確認済み |
| Phase 2：タスクボード + AI会話 | ✅ 完了 | 2026-02-18 | D&D・AI提案・構造化メモ対応済み |
| Phase 3：設定画面 / API接続 ※追加 | ✅ 完了 | 2026-02-18 | 2層構造（admin/個人）で実装 |
| Phase 4：データ収集基盤（設計書Phase 3） | ✅ 完了 | 2026-02-18 | キーワード抽出・ノード蓄積・理解度判定・エッジ/クラスター管理 |
| Phase 5：思考マップUI（設計書Phase 4） | ✅ 完了 | 2026-02-19 | D3.jsネットワークグラフ・段階表示・比較モード |
| **再定義v2：根本整理** | **✅ 完了** | **2026-02-19** | **ノード純化・ナレッジマスタ・ジョブ/タスク分離等** |

> **注意：** 設計書のPhase 3（データ収集基盤）の前に「設定画面」を追加実装したため、
> 設計書のPhase番号と実装のPhase番号に1つズレがあります。
> 設計書Phase 3 = 実装Phase 4、設計書Phase 4 = 実装Phase 5。
> ※設計書v2でPhase番号を統一予定

---

## ⚠️ 再定義v2（2026-02-19決定）

> Phase 5完了後、実際の思考マップ画面を確認した結果、根本的な見直しを実施。
> 詳細は `NODEMAP_再定義v2_議論まとめ.md` を参照。以下はサマリ。

### 変更点サマリ

**1. ノード（点）の純化**
- 変更前：ノード＝キーワード・人名・案件名が混在
- 変更後：ノード＝キーワード（名詞）のみ。人・案件・タスクはフィルター条件に移行
- 常時表示の原則：全ノードが常に表示。ノード数＝知識保有量

**2. ナレッジマスタ（新規）**
- 組織共通のキーワード階層分類体系
- 第1階層：領域（ドメイン）例：マーケティング、会計、開発
- 第2階層：分野（フィールド）例：SEO、広告運用、フロントエンド
- 第3階層：キーワード（ノードそのもの）
- AIが自動分類。マスタは組織で1つ共有

**3. 関係値情報（新規）**
- チャネル登録：API連携時にユーザーが対象選択→AIが初期値提案
- コンタクトリスト：メール宛先等から自動生成、メインチャネル自動判定
- 関係属性：自社メンバー/クライアント/パートナー（AI推定＋ユーザー確認）

**4. エッジ（線）の再定義 — 本流と支流**
- チェックポイント：AI自動記録＋ユーザー任意ボタン
- 本流：第2階層（分野）レベルでCPをつなぐ。矢印で方向表示
- 支流：第3階層（キーワード）の飛地を細い線で表現

**5. タスクの二分化**
- ジョブ（AI起点）：検知→下書き生成→提案カード→実行/却下。思考マップ対象外
- タスク（人間起点）：種を保存→AI構造化→確定→構想→進行→結果。思考マップ対象
- 種の入口：メッセージから「種にする」or 自由入力 → 種ボックスに集約

**6. 表示切り替え追加**
- ステータス別（未着手/進行中/完了）
- 時間軸別（今日/明日/明後日 or 日付指定）

**7. UI修正**
- 配色：基本3色に限定（例外4色）
- アイコン：Slack/Chatwork/Gmail公式ロゴを全画面で統一

---

## 技術スタック（確定）

| 領域 | 技術 | 確定度 |
|------|------|--------|
| フロントエンド | Next.js 14 (App Router) + React + TypeScript | ✅ 確定 |
| CSS | Tailwind CSS 3 | ✅ 確定 |
| ホスティング | Vercel | ✅ 確定 |
| データベース | Supabase（PostgreSQL） | ✅ 確定（スキーマ作成済・未接続） |
| AI | Anthropic Claude API（claude-opus-4-5） | ✅ 確定（デモモード対応） |
| D&D | @dnd-kit/core + @dnd-kit/sortable | ✅ 確定 |
| グラフ表示 | D3.js（@types/d3） | ✅ 確定 |
| API連携 | Gmail API / Slack API / Chatwork API | ✅ 確定（デモモード対応） |

---

## API連携の準備状況

| サービス | APIキー取得 | 備考 |
|----------|-----------|------|
| Gmail / メール | ⬜ 未取得 | Gmail APIまたはIMAP/SMTP。設定画面のadmin設定で入力可能 |
| Slack | ⬜ 未取得 | Bot Token。設定画面のadmin設定で入力可能 |
| Chatwork | ⬜ 未取得 | APIトークン。設定画面のadmin設定で入力可能 |
| Anthropic | ⬜ 未取得 | APIキー。設定画面のadmin設定で入力可能 |
| Supabase | ⬜ 未取得 | URL + Anon Key。設定画面のadmin設定で入力可能 |

> 全サービスがデモモードで動作中。API情報を設定すれば実接続に切り替わる設計。

---

## チェックポイント履歴

### CP1：コンセプト確認
- **結果：** ✅ 承認（修正なし）
- **日付：** 2026-02-18
- **決定事項：** 表の層（集約・補助）と裏の層（思考可視化）の二層構造で進める

### CP6：Phase 1完了確認（統合インボックス）
- **結果：** ✅ 承認
- **日付：** 2026-02-18
- **確認事項：**
  - 3チャネル（Gmail/Slack/Chatwork）の受信メッセージ一覧表示 → OK
  - AI返信下書き生成機能 → OK
  - チャネルフィルタ・検索 → OK
  - スレッド履歴表示 → OK
  - 公式ロゴSVGアイコン・ステータスバッジ → OK

### CP7：Phase 2完了確認（タスクボード + AI会話）
- **結果：** ✅ 承認（複数回の改善フィードバック後）
- **日付：** 2026-02-18
- **確認事項：**
  - カンバンボード（D&D対応）→ OK
  - AI提案カラム（判断材料・却下ボタン付き）→ OK
  - タスク3フェーズ（構想→進行→結果）→ OK
  - 構造化構想メモ（ゴール/主な内容/気になる点/期限日）→ OK
  - 進行フェーズAI補助クイックアクション → OK
  - 結果フェーズ自動要約 → OK
  - 優先度テキストバッジ（高/中/低）→ OK

### CP追加：Phase 3完了確認（設定画面）
- **結果：** ✅ 承認
- **日付：** 2026-02-18
- **確認事項：**
  - 設定画面2層構造（管理者設定 / 個人設定）→ OK
  - admin: API基盤設定（Gmail/Slack/Chatwork/OpenAI/Supabase）→ OK
  - admin: 接続テスト機能 → OK
  - 個人: チャネルOAuth認証カード → OK
  - 個人: プロフィール設定 → OK
  - 個人: 表示・通知設定 → OK

### CP8：Phase 4完了確認（データ収集基盤）
- **結果：** ✅ 承認
- **日付：** 2026-02-18
- **確認事項：**
  - キーワード抽出エンジン（AI/デモモード両対応）→ 実装済み
  - ノード（点）蓄積・頻出度カウント → 実装済み
  - 理解度レベル自動判定（認知/理解/習熟）→ 実装済み
  - エッジ（線）記録（共起/順序/因果の3タイプ）→ 実装済み
  - クラスター（面）管理（構想面/結果面/差分計算）→ 実装済み
  - 既存フローへの統合（メッセージ取得・タスク会話）→ 実装済み

### CP9：Phase 5完了確認（思考マップUI）
- **結果：** ✅ 承認
- **日付：** 2026-02-19
- **確認事項：**
  - D3.jsネットワークグラフ表示（ノード・エッジ・クラスター）→ 実装済み
  - タスク選択→構想・経路・結果の段階表示 → 実装済み
  - ノード理解度別サイズ/色（認知=グレー小、理解=青中、習熟=緑大）→ 実装済み
  - ノードタイプ別形状（キーワード=丸、人物=ダイヤ、プロジェクト=四角）→ 実装済み
  - ユーザー切替機能（4デモユーザー）→ 実装済み
  - 比較モード（2人並列表示）→ 実装済み
  - 統計パネル（種別分布・理解度分布・クラスター差分）→ 実装済み
  - ドラッグ・ズーム・ツールチップ → 実装済み

### CP10：再定義v2確認
- **結果：** ✅ 承認
- **日付：** 2026-02-19
- **確認事項：**
  - ノード純化（キーワードのみ。人・案件・タスクはフィルターに）→ 合意
  - ナレッジマスタ（組織共通3階層分類、AI自動分類）→ 合意
  - 関係値情報（チャネル登録、コンタクトリスト、関係属性）→ 合意
  - エッジ再定義（本流・支流、チェックポイント記録）→ 合意
  - タスク二分化（ジョブ＝AI起点 / タスク＝人間起点）→ 合意
  - 種ボックス（入口複数、出口1つ）→ 合意
  - 表示切り替え（ステータス別 + 時間軸別）→ 合意
  - UI修正（配色3色統一、アイコン公式ロゴ統一）→ 合意

---

## 決定事項ログ

| 日付 | 決定内容 | 理由 |
|------|---------|------|
| 2026-02-18 | サービス名は「NodeMap」（仮） | 点・線・面のコンセプトに合致 |
| 2026-02-18 | 初期ソースはメール・Slack・Chatworkの3つ | 将来LINE・メッセンジャー等に拡張 |
| 2026-02-18 | チーム間でタスク・ノードマップを覗き合える設計 | 上司→部下の指導、部下→上司の学び、同僚間の相互学習 |
| 2026-02-18 | まず自社利用 → ゆくゆく外販（SaaS） | 自社で検証してから展開 |
| 2026-02-18 | 開発はGitHub + Vercel構成 | 非エンジニアがv0.dev + Claude Coworkで構築 |
| 2026-02-18 | SSOTはMarkdownでローカル保持 | 各フェーズ間の引き継ぎに使用 |
| 2026-02-18 | フォルダ構成・命名規則・格納ルールを設計書セクション7に定義 | ファイル無秩序化を防止 |
| 2026-02-18 | 定型文テンプレート（PROMPT_TEMPLATE.md）を運用 | 毎回の個別指示を不要にする |
| 2026-02-18 | デモモードパターン採用 | API未接続時もUIを確認可能に |
| 2026-02-18 | @dnd-kit採用 | 軽量で柔軟なD&Dライブラリ |
| 2026-02-18 | タスク3フェーズモデル | 構想→進行→結果で思考プロセスを構造化 |
| 2026-02-18 | AI提案を縦カラム化 | 横バーより多数の提案を表示可能 |
| 2026-02-18 | 構想メモの構造化フォーム | 一定品質のメモを担保（ゴール/内容/懸念/期限） |
| 2026-02-18 | 優先度をテキストバッジに | 絵文字(🔴🟡🟢)より明確。高/中/低の文字表記 |
| 2026-02-18 | 判断材料の充実化 | 誰から/いつ/何のメッセージか分からないとタスク化判断不可 |
| 2026-02-18 | 設計書Phase 3の前に設定画面を追加 | 実運用にはAPI接続設定が必要 |
| 2026-02-18 | 設定を2層構造に | admin(API基盤)と個人(OAuth認証)は分離すべき。admin未設定時は個人認証不可 |
| 2026-02-18 | キーワード抽出はAI（gpt-4o-mini）+ルールベースのハイブリッド | API未接続時はルールベース（カタカナ・漢字・人名パターン）で動作 |
| 2026-02-18 | 理解度3段階の判定ロジック確定 | received only=認知、sent/self=理解、sent×2+received=習熟 |
| 2026-02-18 | エッジは3タイプ（共起/順序/因果） | 共起=同時出現、順序=進行フェーズの経路、因果=AI文脈解析 |
| 2026-02-18 | クラスターは構想面と結果面の2種類 | 差分で「思考の広がり」を計測。discoveredOnPath=経路上の発見 |
| 2026-02-18 | 既存フローに非同期統合 | メッセージ取得・タスク会話時にバックグラウンドでノード蓄積。エラーは無視 |
| 2026-02-19 | AI基盤をOpenAIからAnthropic Claudeに全面移行 | ユーザー指示。claude-opus-4-5-20251101を使用。openaiパッケージ削除、@anthropic-ai/sdk採用 |
| 2026-02-19 | グラフ描画ライブラリはD3.jsに確定 | React Flowより低レベル制御が可能 |
| 2026-02-19 | ノード形状を種別で区別 | キーワード=丸、人物=ダイヤモンド、プロジェクト=四角 |
| 2026-02-19 | 理解度をサイズ＋色で表現 | 認知=小グレー、理解=中青、習熟=大緑 |
| 2026-02-19 | 比較モードは2人並列表示 | 設計書の要件通り |
| **2026-02-19** | **ノードをキーワードのみに純化** | **人・案件・タスクはフィルター条件に分離。マップの役割を明確化** |
| **2026-02-19** | **ナレッジマスタを組織共通で1つ作成** | **個人ごとの分類では比較不能。キーワードの階層は組織共通であるべき** |
| **2026-02-19** | **AIが自動分類（3階層：領域/分野/キーワード）** | **ユーザー負荷を最小化。自動分類で秩序を作る** |
| **2026-02-19** | **関係値情報の定義を追加** | **チャネル属性・コンタクトリスト・関係属性（自社/クライアント/パートナー）** |
| **2026-02-19** | **エッジを「本流・支流」に再定義** | **思考の「つながり」ではなく「流れ」を表現。方向（矢印）が重要** |
| **2026-02-19** | **チェックポイント記録方式を採用** | **AI自動記録＋ユーザー任意ボタン。構想〜結果間のブラックボックスを解消** |
| **2026-02-19** | **本流は第2階層、支流は第3階層で描画** | **処理負荷と可読性のバランス** |
| **2026-02-19** | **タスクをジョブとタスクに二分化** | **ジョブ＝AI起点（定型）、タスク＝人間起点（思考型）。思考マップはタスクのみ対象** |
| **2026-02-19** | **種ボックスの導入** | **入口複数（メッセージから/自由入力）→ 種ボックスに集約 → AI構造化 → 確定** |
| **2026-02-19** | **表示切り替え追加（ステータス別＋時間軸別）** | **「何が残っているか」と「今日何やるか」は別の視点** |
| **2026-02-19** | **配色を基本3色に限定** | **カラフルすぎて情報優先度が不明。統一化で可読性向上** |
| **2026-02-19** | **アイコンを公式ロゴに全画面統一** | **インボックス以外で別アイコンが使われていた問題を解消** |
| **2026-02-19** | **DB処理速度対策が必要** | **インデックス設計（user_id/キーワード/案件ID/理解度）。将来はキャッシュ層** |
| **2026-02-19** | **ローカルフォルダ運用を導入** | **current/（最新版）+ history/（差分保存）。ローカルが正、GitHubはコピー** |

---

## 実装済みファイル構成

```
node_map/
├── NODEMAP_SSOT.md
├── docs/
│   └── README.md
├── public/
│   └── icons/                         ← チャネル公式ロゴSVG
│       ├── gmail.svg
│       ├── slack.svg
│       └── chatwork.svg
├── src/
│   ├── app/
│   │   ├── layout.tsx                 ← ルートレイアウト
│   │   ├── page.tsx                   ← トップ（/inbox にリダイレクト）
│   │   ├── globals.css
│   │   ├── inbox/page.tsx             ← 画面①統合インボックス
│   │   ├── tasks/page.tsx             ← 画面②タスクボード（DndContext）
│   │   ├── settings/page.tsx          ← 設定画面（2タブ構成）
│   │   ├── nodemap/page.tsx          ← 画面③④思考マップ（D3.jsグラフ）
│   │   └── api/
│   │       ├── messages/
│   │       │   ├── route.ts           ← メッセージ一覧取得
│   │       │   └── reply/route.ts     ← 返信送信
│   │       ├── ai/
│   │       │   └── draft-reply/route.ts ← AI返信下書き
│   │       ├── tasks/
│   │       │   ├── route.ts           ← タスクCRUD
│   │       │   ├── chat/route.ts      ← AI会話・要約生成
│   │       │   └── suggestions/route.ts ← タスク提案
│   │       ├── settings/
│   │       │   ├── route.ts           ← 設定取得・保存
│   │       │   ├── profile/route.ts   ← プロフィール更新
│   │       │   └── test/route.ts      ← 接続テスト
│   │       ├── nodes/
│   │       │   ├── route.ts           ← ノードCRUD
│   │       │   ├── extract/route.ts   ← キーワード抽出→ノード蓄積
│   │       │   └── stats/route.ts     ← ノード統計
│   │       ├── edges/
│   │       │   └── route.ts           ← エッジCRUD
│   │       ├── nodemap/
│   │       │   ├── route.ts           ← ノードマップ全体データ取得
│   │       │   └── users/route.ts     ← マップユーザー一覧
│   │       └── clusters/
│   │           ├── route.ts           ← クラスターCRUD
│   │           └── diff/route.ts      ← クラスター差分計算
│   ├── components/
│   │   ├── inbox/
│   │   │   ├── MessageList.tsx
│   │   │   ├── MessageDetail.tsx
│   │   │   ├── ReplyForm.tsx
│   │   │   └── ThreadView.tsx
│   │   ├── tasks/
│   │   │   ├── TaskCard.tsx           ← カンバンカード（useSortable）
│   │   │   ├── TaskColumn.tsx         ← ドロップ可能カラム
│   │   │   ├── TaskDetail.tsx         ← 詳細パネル（AI会話/詳細タブ）
│   │   │   ├── TaskAiChat.tsx         ← AI会話UI
│   │   │   ├── TaskSuggestions.tsx     ← AI提案カラム+詳細モーダル
│   │   │   └── CreateTaskModal.tsx    ← タスク作成モーダル
│   │   ├── settings/
│   │   │   ├── ConnectionOverview.tsx  ← 接続ステータス概要
│   │   │   ├── ServiceSettingsCard.tsx ← サービス設定カード（admin）
│   │   │   ├── ProfileSettings.tsx    ← プロフィール設定
│   │   │   ├── ChannelAuthCard.tsx    ← チャネル認証カード（個人）
│   │   │   └── UserPreferencesCard.tsx ← ユーザー設定
│   │   ├── shared/
│   │   │   ├── Header.tsx
│   │   │   └── Sidebar.tsx
│   │   ├── ui/
│   │   │   ├── Button.tsx
│   │   │   ├── ChannelBadge.tsx
│   │   │   └── StatusBadge.tsx
│   │   └── nodemap/
│   │       ├── NetworkGraph.tsx       ← D3.jsネットワークグラフ本体
│   │       ├── MapControls.tsx        ← 操作パネル（ユーザー/タスク/モード切替）
│   │       └── MapStats.tsx           ← 統計情報パネル
│   ├── hooks/
│   │   ├── useMessages.ts
│   │   ├── useTasks.ts
│   │   ├── useSettings.ts
│   │   ├── useNodes.ts              ← ノード・エッジ・クラスター取得Hook
│   │   └── useNodeMap.ts            ← 思考マップUI用データ管理Hook
│   ├── lib/
│   │   ├── types.ts                   ← 全型定義
│   │   ├── constants.ts               ← 全定数
│   │   ├── utils.ts
│   │   └── supabase.ts
│   └── services/
│       ├── email/emailClient.service.ts
│       ├── slack/slackClient.service.ts
│       ├── chatwork/chatworkClient.service.ts
│       ├── ai/
│       │   ├── aiClient.service.ts
│       │   └── keywordExtractor.service.ts ← キーワード抽出エンジン
│       ├── task/taskClient.service.ts
│       ├── settings/settingsClient.service.ts
│       └── nodemap/
│           ├── nodeClient.service.ts      ← ノード（点）管理
│           ├── edgeClient.service.ts      ← エッジ（線）管理
│           └── clusterClient.service.ts   ← クラスター（面）管理
├── supabase/
│   ├── 001_initial_schema.sql
│   ├── 002_tasks_schema.sql
│   └── 003_nodemap_schema.sql        ← ノード・エッジ・クラスターDB
└── package.json
```

---

## 各フェーズの引き継ぎメモ

### Phase 1 → Phase 2 への引き継ぎ
- **実装したファイル構成：** 上記ファイル構成のinbox系ファイル全て
- **使用した技術の最終決定：** Next.js 14 (App Router), TypeScript, Tailwind CSS 3, Supabase, Anthropic Claude API
- **注意点・課題：**
  - 全サービスはデモモードで動作（API未設定時はダミーデータ返却）
  - Supabaseは接続未実施（スキーマのみ作成）
  - 同一案件スレッド化は未実装（将来対応）
  - 公式ロゴSVGはpublic/iconsに格納済み

### Phase 2 → Phase 3（設定画面）への引き継ぎ
- **実装したファイル構成：** tasks系ファイル全て + @dnd-kit関連
- **改善フィードバック対応：**
  - D&D対応（@dnd-kit、8pxの活性化閾値でクリック/ドラッグ区別）
  - AI提案をカラム化（未着手の左側に縦スクロール配置）
  - 判断材料の追加（sourceFrom/sourceDate/sourceSubject/sourceExcerpt）
  - 却下ボタン追加（却下/あとで/タスクに追加の3ボタン）
  - 優先度をテキストバッジに変更（高/中/低）
  - 構想メモの構造化フォーム（ゴール/主な内容/気になる点/期限日）
  - 進行フェーズのAI補助クイックアクション（4種）
  - 詳細タブの再設計

### Phase 3（設定画面）→ Phase 4（データ収集基盤）への引き継ぎ
- **実装したファイル構成：** settings系ファイル全て
- **2層構造の設計：**
  - admin設定: API基盤（Client ID/Secret, Bot Token, APIキー, Supabase URL等）
  - 個人設定: OAuth認証（各チャネルへのログイン）+ プロフィール + 表示・通知設定
  - admin未設定時は個人の認証ボタンが無効化される
- **注意点：**
  - 設定は現在インメモリ保存（本番はSupabase暗号化保存が必要）
  - OAuth認証フローはシミュレーション（本番は実際のOAuth2実装が必要）
  - 接続テストもシミュレーション

### Phase 4（データ収集基盤）→ Phase 5（思考マップUI）への引き継ぎ
- **実装したファイル構成：** nodemap系サービス全て + ノードAPI + キーワード抽出エンジン
- **データ収集基盤の設計：**
  - ノード（点）: keyword/person/projectの3タイプ。頻出度カウント・理解度自動判定付き
  - エッジ（線）: co_occurrence/sequence/causalの3タイプ。重み（weight）で太さを表現
  - クラスター（面）: ideation/resultの2タイプ。差分計算でdiscoveredOnPathを算出
  - キーワード抽出: Anthropic Claude API使用。デモモードではルールベース抽出
- **注意点：**
  - 全データはインメモリ保存（本番はSupabase。003_nodemap_schema.sql準備済み）
  - デモ用の初期データ（12ノード・8エッジ・4クラスター）が組み込み済み
  - キーワード抽出のエラーは既存フローに影響させない（非同期・エラー無視パターン）

### Phase 5（思考マップUI）完了 → 再定義v2への引き継ぎ
- **実装したファイル構成：** nodemap/page.tsx + components/nodemap/* + hooks/useNodeMap.ts + api/nodemap/*
- **思考マップUIの設計：**
  - D3.jsフォースレイアウトによるネットワークグラフ表示
  - ノード形状でタイプを区別（丸=キーワード、ダイヤ=人物、四角=プロジェクト）
  - ノードサイズ+色で理解度を表現（認知=小グレー、理解=中青、習熟=大緑）
- **再定義v2で変更が必要な箇所：**
  - ノードタイプの統一（キーワードのみに純化）
  - フィルター機能の追加（人/案件/タスク）
  - ナレッジマスタ基盤の新規構築
  - エッジの本流・支流表現への変更
  - チェックポイント記録機能の新規追加
  - タスクボードのジョブ/タスク分離
  - 種ボックスの新規構築
  - 配色統一・アイコン統一

---

## 次にやること

### 即時対応（次スレッド）
1. **ローカルフォルダ整備** — ai-agent/配下にNodeMapフォルダを作成、current/とhistory/を構築
2. **設計書v2作成** — 再定義v2の内容を反映した設計書を作成
3. **SSOT/設計書のGitHub同期** — ローカルが正、GitHubはコピーの運用を開始

### 再定義v2の実装（Phase 6以降）
4. **UI修正** — 配色3色統一、アイコン公式ロゴ統一
5. **タスクボード改修** — ジョブ/タスク分離、種ボックス、表示切り替え
6. **ナレッジマスタ基盤** — 組織共通の3階層分類体系＋AI自動分類
7. **関係値情報基盤** — チャネル登録フロー、コンタクトリスト、関係属性
8. **思考マップUI改修** — ノード純化、フィルター、本流/支流、チェックポイント
9. **Supabase接続** — インメモリからDBへの切り替え
10. **APIキー準備・実データ検証**

---

## ローカルフォルダ運用ルール

### フォルダ構成
```
ai-agent/
└── XX_NodeMap/              ← 連番は既存フォルダに合わせる
    ├── current/             ← 常に最新版のみ
    │   ├── NODEMAP_SSOT.md
    │   ├── PROMPT_TEMPLATE.md
    │   ├── NODEMAP_再定義v2_議論まとめ.md
    │   └── NodeMap_設計書_vX.docx
    ├── history/             ← 差分を撮り溜め
    │   └── YYYY-MM-DD_変更内容/
    └── README.md
```

### 格納ルール
- `current/` には常に最新版のみ。古いファイルは置かない
- フェーズ完了時や大きな変更時に `history/` へスナップショット保存
- historyのフォルダ名は `YYYY-MM-DD_変更内容` の形式
- 設計書のバージョンが上がる場合はファイル名も変える

### 運用フロー
1. スレッド開始時：ユーザーがcurrent/のファイルをClaudeに渡す
2. スレッド内で作業・議論
3. スレッド完了時（Claudeがやること）：
   - current/のファイルを更新
   - history/にスナップショット保存
   - GitHubにも同期
4. **常にローカルcurrent/が正。GitHubはそのコピー。ズレた場合はローカルが勝つ。**

---

## 運用ルール（要約）

> 詳細は設計書セクション7を参照

| ルール | 内容 |
|--------|------|
| フォルダ構成 | 設計書7-1の固定ツリーに従う |
| 命名規則 | 設計書7-2の表に従う |
| 格納ルール | 設計書7-3の7項目を厳守 |
| コミット | 日本語、[種別] 形式、1機能1コミット |
| フェーズ完了時 | SSOTを更新→不要ファイル削除→構成確認→コミット→CHECKPOINT提示 |
| ローカルフォルダ | current/が正、GitHubはコピー |

---

## GitHub認証情報

| 項目 | 値 |
|------|-----|
| リポジトリ | https://github.com/nextstage2018/node_map |
| ブランチ | main |
| user.name | sjinji |
| user.email | suzuki@next-stage.biz |
| 認証方式 | Fine-grained personal access token（7日間ローテーション） |
| トークン | **ローカルのcurrent/NODEMAP_SSOT.mdに記載（GitHub非公開）** |

> **運用ルール：** トークンはGitHubにプッシュするとSecret Scanningでブロックされるため、ローカルのSSOTにのみ記載。エージェントはローカルSSOTからトークンを取得してプッシュを実行。トークンは7日で期限切れ→新しいトークンを発行しローカルSSOTを更新。

---

## ローカルに保持するファイル一覧

| ファイル | 説明 |
|----------|------|
| `NodeMap_設計書_vX.docx` | サービス全体の設計仕様 |
| `NODEMAP_SSOT.md` | このファイル。進捗・決定事項・引き継ぎ情報 |
| `PROMPT_TEMPLATE.md` | 毎回の会話開始時に使う定型文 |
| `NODEMAP_再定義v2_議論まとめ.md` | 再定義v2の議論詳細 |

---

> **運用ルール**
> - 各フェーズの完了時、エージェントはこのファイルを必ず更新する
> - CHECKPOINTの結果と決定事項を記録する
> - 次のフェーズへの引き継ぎメモを記入する
> - sjinjiさんはCHECKPOINTの確認結果を口頭でエージェントに伝えればOK
