# NodeMap 追加機能アップデート仕様書 v2

Phase 14〜20+ 対応（完全ロードマップ統合版）

作成日：2026-02-19 | 更新日：2026-02-20 | ステータス：Phase 17完了・Hotfix適用済み・Phase 18着手

---

## 1. 背景と目的

NodeMapは現在、メッセージのキーワードを抽出してノードとして蓄積する設計になっている。しかしキーワードだけでは「使った知識の一覧」にとどまり、「何を考え、どう進め、何を決断したか」という思考過程が記録されない。

本アップデートの目的は、タスク処理の過程を会話ログ・状態遷移・インタラクション行動から多角的に記録し、NodeMapを「思考過程の可視化ツール」として進化させることである。

また、蓄積されたデータを活用して、架空の同僚フィードバック（ナレッジの属人化解消）という新しい価値を将来的に提供できる基盤を構築する。

---

## 2. 変更項目一覧（Phase対応表）

| No. | 項目名 | Phase | 概要 | 優先度 | 実装難易度 |
|-----|--------|-------|------|--------|-----------|
| — | Chatwork内部タグ整形 | **Phase 14** | 生タグの整形表示（インフラ改善） | 高 | 低 |
| — | Slack接続 | **Phase 15** | 3チャネル全実データ接続（インフラ改善） | 中 | 中 |
| ① | ノード登録・カウント設計の変更 | **Phase 16** | 能動的インタラクション起点のみ登録。累計カウント導入。理解度3段階廃止 | 高 | 中 |
| ② | 会話ログの構造化分類 | **Phase 17** | タスク内AI会話を固定7タグで自動分類・記録 | 高 | 低 |
| ③ | タスク状態遷移のタイムスタンプ記録 | **Phase 17** | 各フェーズの所要時間を記録。平均値提示・逸脱アラート | 高 | 低 |
| — | インボックスから「種にする」 | **Phase 18** | メッセージからワンクリックで種ボックスに投入 | 中 | 中 |
| ④ | 受信メッセージへのAIタスク化提案 | **Phase 18** | タスク化推奨の判定・理由・選択肢をAIが提示 | 中 | 中 |
| ⑤ | 会話UI改善 | **Phase 19** | タスクカードへの会話入口常時表示・最新一言の一覧表示 | 中 | 中 |
| ⑥ | 今週のノード一覧（週次バナー） | **Phase 20** | 週次で理解が深まったノードを本人確認。バナー形式で表示 | 中 | 低 |
| ⑦ | 架空の同僚フィードバック | **将来** | 蓄積データから同僚の思考をAIが再現する三者間会話モード | 将来 | 高 |

---

## 3. 各項目の詳細仕様

### Phase 14：Chatwork内部タグの整形（インフラ改善）

**背景**

Chatwork APIから取得したメッセージ本文に `[rp aid=12345]` や `[To:12345]` のような生タグがそのまま表示されており、読みづらい。

**変更内容**

- `[rp aid=XXX]` → 引用表示に変換または除去
- `[To:XXX]名前` → `@名前` に変換
- `[info]...[/info]` → 整形表示
- `[code]...[/code]` → コードブロック表示
- `[hr]` → 水平線
- その他の未対応タグを除去

**対象ファイル**

- `src/lib/utils.ts` の `cleanChatworkBody()` を拡張

---

### Phase 15：Slack接続（インフラ改善）

**背景**

メール・Chatworkが動いている今、Slackがつながれば3チャネル全てが実データで揃う。

**前提条件**

- sjinji さん側でSlack Bot Tokenの取得が必要
- Slack API（https://api.slack.com/apps）でAppを作成
- Bot Token Scopes: `channels:history`, `channels:read`, `chat:write`, `users:read`
- ワークスペースにインストール → `xoxb-` で始まるBot Tokenを取得
- Vercel環境変数に `SLACK_BOT_TOKEN` として設定

**変更内容**

- `slackClient.service.ts` を実API対応に改修
- チャンネル一覧取得 → メッセージ取得 → UnifiedMessage変換
- Slackの `msg.files` 配列から添付ファイル情報を取得
- 設定画面のSlack接続ステータスを実API対応に修正

---

### Phase 16 — ①ノード登録・カウント設計の変更

**現状の問題**

メッセージを受信するだけで自動的にノード登録されるため、メルマガ等の一方的な受信メッセージがノイズとして蓄積される。また理解度の3段階（認知・理解・習熟）は判定精度が低く、実用上の意味が薄い。

**変更内容**

- **登録条件：** 以下のいずれか1回以上の能動的インタラクションがあったもののみノード登録
  - トリガー①：自分が返信した
  - トリガー②：タスクに紐づけた
  - トリガー③：AI会話の中でそのキーワードを使用した
  - トリガー④：「種にする」ボタンを押した
  - トリガー⑤：手動で「認知マーク」をつけた（意図的に残したい場合の任意操作）
- **カウント：** 上記トリガー全てを同等として累計インタラクション回数をカウント
- **表示：** カウント数は裏側で保持し、表示上は視覚的シグナル（カウント多=濃い色）に留める

**廃止項目**

- 理解度3段階（認知・理解・習熟）の自動判定ロジックは廃止
- 一方向受信のみのメッセージはノード登録対象外

**影響範囲**

- `nodeClient.service.ts` — ノード登録条件・カウントロジック変更
- `keywordExtractor.service.ts` — 抽出後の登録判定変更
- `NetworkGraph.tsx` — ノードサイズ/色の描画ロジック変更
- `types.ts` — NodeData型変更（level廃止→interactionCount追加）
- DB: `user_nodes` テーブルのカラム変更

**SSOTとの整合性**

- Phase 4で実装した理解度判定（認知/理解/習熟）を廃止
- Phase 5で実装したノードサイズ/色表現を累計カウントベースに変更
- Phase 10のノードフィルター機能はそのまま維持

---

### Phase 17 — ②会話ログの構造化分類 + ③タスク状態遷移タイムスタンプ

#### ②会話ログの構造化分類

**概要**

タスク内のAI会話で「どんな種類の質問をしたか」をAIが自動判定し、固定タグとして記録する。「どのフェーズで外部に頼る傾向があるか」という思考パターンが可視化される。

**固定タグ（7種類・追加不可）**

| タグ名 | 該当する会話の例 |
|--------|----------------|
| 情報収集 | 「〜とは何か」「〜の事例を教えて」「〜について調べて」 |
| 判断相談 | 「〜と〜どちらがいいか」「〜の場合どうすべきか」 |
| 壁の突破 | 「うまくいかない」「詰まっている」「どうすればいいかわからない」 |
| アウトプット生成 | 「〜を作って」「〜を書いて」「〜の文章を作成して」 |
| 確認・検証 | 「これで合っているか」「この理解は正しいか」「この仮説はどうか」 |
| 整理・構造化 | 「整理したい」「まとめて」「順番をつけると」 |
| その他 | 上記6タグに該当しないもの。増えたら定期的に見直しを検討 |

**実装上の注意**

- タグはAIが会話内容から自動判定（ユーザーの手動操作不要）
- タグは固定7種類。増やさない
- 1回の会話に複数タグが該当する場合は最も強いシグナルを1つ選択

**対象ファイル**

- `aiClient.service.ts` — 分類ロジック追加
- `taskClient.service.ts` — タグ保存
- `types.ts` — ConversationTag型追加
- DB: `task_conversations` テーブルに `conversation_tag` カラム追加

#### ③タスク状態遷移のタイムスタンプ記録

**概要**

種→構想→進行→結果の各ステータス移動の日時を記録する。各フェーズの所要時間を算出し、個人の傾向分析および類似タスクの参考情報として活用する。

**記録内容**

- 種→構想・構想→進行・進行→結果の各移行日時
- 各フェーズの所要時間（自動計算）

**活用方法**

- 個人ダッシュボード：「あなたは構想フェーズに平均○日かけています」等の傾向提示
- 類似タスク検索時：「このタスクは構想に○日、進行に○日かかりました」を過程情報として表示
- 平均値算出：同タイプのタスクの平均所要時間を「このタイプは平均○日」として提示
- 逸脱アラート：平均より大幅に長い場合に気づきとして表示

**実装上の注意**

- 既存のステータス変更機能にタイムスタンプ付加のみ。基本設計変更不要

**対象ファイル**

- `taskClient.service.ts` — ステータス変更にタイムスタンプ付加
- `types.ts` — TaskTransitionHistory型追加
- DB: `tasks` テーブルに `seed_at`, `ideation_at`, `progress_at`, `result_at` カラム追加

---

### Phase 18 — インボックスから「種にする」+ ④AIタスク化提案

#### インボックスから「種にする」

**概要**

3チャネルが揃った状態で、メッセージからワンクリックで種ボックスに投入できるようにする。インボックスとタスクボードがつながる重要な機能。

**変更内容**

- MessageDetail / ConversationBubble に「🌱 種にする」ボタン追加
- クリック → 種ボックスAPI（`/api/seeds`）にPOST → メッセージ内容を種として保存
- 種ボックスでAI構造化 → タスク化の既存フローに接続
- 送信元・チャネル・日時をメタデータとして保持
- Phase 16のノード登録トリガー④と連動

#### ④受信メッセージへのAIタスク化提案

**背景**

タスク化はユーザーの裁量に委ねられているため、対応品質にばらつきが生じる（「見積書のみ」vs「提案資料まで」）。AIが受信メッセージを解析し、タスク化の推奨と範囲の選択肢を提示することでばらつきを減らす。

**機能概要**

- 受信メッセージを解析し、AIがタスク化推奨度を自動判定
- 推奨度が高い場合、メッセージカードに「タスク化を推奨します」バナーと理由を表示
- タスク化ボタン押下時に「最低限の対応」と「推奨対応」の2案をAIが提示
- ユーザーはいずれかを選択してタスク化（無視も可）

**2案の提示例**

受信メッセージ：「来週までに見積もりをお願いします」

- 最低限の対応：見積書を作成して送付する
- 推奨対応：見積書＋提案理由・費用対効果を添えた提案資料を作成する

**実装上の注意**

- 現在のジョブ（AI起点）機能を拡張する形で実装

**対象ファイル**

- `MessageDetail.tsx` — 種ボタン＋推奨バナー追加
- `aiClient.service.ts` — タスク化判定＋2案生成
- 新規: `/api/ai/task-suggestion/route.ts`

---

### Phase 19 — ⑤会話UI改善

**改善1：タスクカードへの会話入口の常時表示**

- タスクカード上に一言入力フィールドを常時表示
- カードを開かずにそのままAIに話しかけられる（1クリックゼロ）

**改善2：最新会話の一覧表示**

- タスク一覧でカードに最後のAI発言の冒頭を表示
- 「続きを話したい」という動線を自然に作る
- 未読の会話がある場合はバッジで通知

**スコープ外（今回対象外）**

- インボックスからシームレスにタスク会話に接続する機能は今回対象外

**対象ファイル**

- `TaskCard.tsx` — インライン入力フィールド＋最新発言プレビュー
- `TaskColumn.tsx` — 未読バッジ

---

### Phase 20 — ⑥今週のノード一覧（週次バナー）

**概要**

週次でツール上部にバナーを表示し、今週触れたノードの中から「理解が深まったもの」を本人に選んでもらう。自動カウントに加えて本人の自覚を記録することでノードの信頼性を高める。

**バナーの仕様**

- 表示タイミング：週次（推奨：月曜朝）にツールを開いた際に上部バナーとして表示
- 表示内容：「今週あなたが触れたノードです。理解が深まった・自分で調べたものはどれですか？」
- UI：ノードをタグ形式で一覧表示。タップして選択→送信
- 選択したノードは累計カウントに加算 + 「本人確認済み」フラグを付与
- バナーは一度回答すると翌週まで非表示

**データの二層構造**

- 自動カウント：能動的インタラクションの形跡
- 本人確認済み：週次バナーでユーザー自身が選択したもの

**対象ファイル**

- 新規: `WeeklyNodeBanner.tsx`
- `nodeClient.service.ts` — 確認済みフラグ追加
- DB: `user_nodes` テーブルに `user_confirmed`, `confirmed_at` カラム追加

---

### 将来Phase — ⑦架空の同僚フィードバック

**概要**

蓄積されたメンバーのデータ（ノード・会話ログ・タスク過程）を元に、AIがそのメンバーの思考を再現して会話に参加する三者間モード。

**機能仕様**

- 会話画面にプルダウンで「相談相手を選ぶ」ボタンを設置
- 選択後は三者間モードに切り替わる（自分・AI・架空の同僚）
- AIは選んだ同僚のノード保有状況・会話タグ傾向・タスク過程をコンテキストとして使用

**解放条件**

- 対象メンバーのノードが一定数（例：50件）蓄積された時点で機能を解放

**今フェーズの対応**

- 機能定義・設計のみ。実装は将来フェーズ
- Phase 16〜20のデータ蓄積が前提条件

---

## 4. 実装優先順位と依存関係

| No. | 項目名 | Phase | 依存関係 | 優先度 | 実装難易度 |
|-----|--------|-------|---------|--------|-----------|
| — | Chatwork内部タグ整形 | 14 | なし | 高 | 低 |
| — | Slack接続 | 15 | なし（Bot Token準備要） | 中 | 中 |
| ① | ノード登録・カウント設計 | 16 | なし（基盤変更） | 高 | 中 |
| ②③ | 会話ログ分類+タイムスタンプ | 17 | 既存会話/ステータス機能 | 高 | 低 |
| ④ | 種にする+AIタスク化提案 | 18 | Phase 16（トリガー④） | 中 | 中 |
| ⑤ | 会話UI改善 | 19 | 既存タスクボードUI | 中 | 中 |
| ⑥ | 週次バナー | 20 | Phase 16（ノード設計後） | 中 | 低 |
| ⑦ | 架空の同僚（将来） | 将来 | Phase 16〜20全て完了後 | 将来 | 高 |

### 依存関係マップ

```
Phase 14 (Chatworkタグ) ──┐
Phase 15 (Slack接続) ─────┤──→ 3チャネル完成
                          │
Phase 16 (ノード設計変更) ─┤──→ 基盤変更（後続全てに影響）
                          │         │
Phase 17 (会話タグ+時間) ──┘         │
                                    ↓
Phase 18 (種にする+AI提案) ──────→ インボックス↔タスク接続
                                    │
Phase 19 (会話UI改善) ──────────→ タスクボードUX向上
                                    │
Phase 20 (週次バナー) ─────────→ Phase 16のノード設計に依存
                                    │
将来: 架空の同僚 ──────────────→ Phase 16〜20全完了が前提
将来: 認証/RLS/SaaS化 ─────────→ 複数人利用開始時
```

---

## 5. 実装上の共通注意事項

- Phase 16のノード登録設計変更は他の全機能の基盤となるため、Phase 14/15の後に最初に実装すること
- 既存のデモモードとの併存設計は維持する（Supabase未接続時もデモで動作）
- 将来Phaseの架空の同僚フィードバックは今フェーズで実装しない。設計定義のみ
- 各機能の追加に伴いSSOTを更新し、Cowork側でGitHubにプッシュすること
- Phase 4で実装した理解度3段階はPhase 16で廃止。Phase 5のノード表示も連動変更
- Phase 7の種ボックスはPhase 18で「インボックスからの入口」が追加される

---

## 6. 更新履歴

| 日付 | 更新者 | 内容 |
|------|--------|------|
| 2026-02-19 | sjinji | 初版作成。Phase 12後半〜Phase 13の追加機能仕様を定義 |
| 2026-02-20 | sjinji + Claude | v2作成。Phase 14〜20+の完全ロードマップに統合。SSOTと整合性確保。依存関係マップ追加 |
| 2026-02-20 | Claude | Hotfix: インボックスUI修正3件（Slack/Chatworkカードクリック時のボタン消失修正、送信メッセージのローカル表示対応、設定ページにヘッダー追加）。管理者設定タブをステータス表示のみに簡素化（API入力フォーム削除→接続済み/未接続のみ表示）。送信メッセージの永続化は次フェーズで対応予定 |
